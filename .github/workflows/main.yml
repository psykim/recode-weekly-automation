name: RECODE WEEKLY 자동 생성 및 발송

on:
  schedule:
    # 매주 금요일 0시 (KST) = 목요일 15시 (UTC)
    - cron: '0 15 * * 4'
  workflow_dispatch: # 수동 실행 가능

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-send:
    runs-on: ubuntu-latest
    
    steps:
      - name: 체크아웃
        uses: actions/checkout@v4
        
      - name: Python 설정
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: 의존성 설치
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: 보고서 생성 및 발송
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        run: |
          # 보고서 생성하고 경로 캡처
          REPORT_OUTPUT=$(python scripts/generate_report.py)
          echo "$REPORT_OUTPUT"
          
          # REPORT_PATH 추출
          REPORT_PATH=$(echo "$REPORT_OUTPUT" | grep "REPORT_PATH=" | cut -d'=' -f2)
          
          # 이메일 발송
          if [ -n "$REPORT_PATH" ]; then
            export REPORT_PATH
            python scripts/send_email.py
          else
            echo "보고서 경로를 찾을 수 없습니다"
            exit 1
          fi
          
      - name: 보고서 업로드
        uses: actions/upload-artifact@v4
        with:
          name: weekly-reports
          path: reports/
          
      - name: GitHub Pages에 배포
        run: |
          mkdir -p gh-pages
          cp -r reports/* gh-pages/
          cd gh-pages
          touch .nojekyll
          echo "<!DOCTYPE html><html><head><title>RECODE WEEKLY</title></head><body><h1>RECODE WEEKLY Reports</h1><ul>" > index.html
          for file in *.html; do
            [ "$file" != "index.html" ] && echo "<li><a href='$file'>$file</a></li>" >> index.html
          done
          echo "</ul></body></html>" >> index.html
          
      - name: GitHub Pages 배포
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
          cname: # 커스텀 도메인이 있으면 추가
